var firebaseConfig={apiKey:"AIzaSyBRbnSyy0PVVOGPzfNR-uIlKpaV7XZjAMA",authDomain:"gestion-tecnica-16316.firebaseapp.com",databaseURL:"https://gestion-tecnica-16316-default-rtdb.firebaseio.com",projectId:"gestion-tecnica-16316",storageBucket:"gestion-tecnica-16316.firebasestorage.app",messagingSenderId:"499818297675",appId:"1:499818297675:web:f20dbb7abed02d718090ce"};
var db=null,desarrollos=[],fioriApps=[],transportes=[],editingId=null,editingType=null;
function initFirebase(){try{updateStatus('connecting','üîÑ Conectando...');firebase.initializeApp(firebaseConfig);db=firebase.database();db.ref('.info/connected').on('value',function(s){if(s.val()){updateStatus('connected','‚úÖ Conectado');loadAllData()}else{updateStatus('disconnected','‚ùå Desconectado')}})}catch(e){updateStatus('disconnected','‚ùå Error');notify('Error: '+e.message,'error')}}
function updateStatus(status,text){var el=document.getElementById('firebaseStatus');el.textContent=text;el.className='firebase-status status-'+status}
function loadAllData(){db.ref('desarrollos').on('value',function(s){var data=s.val();desarrollos=data?Object.keys(data).map(function(k){return Object.assign({id:k},data[k])}):[];desarrollos.sort(function(a,b){return new Date(b.fechaInicio||0)-new Date(a.fechaInicio||0)});document.getElementById('loading-desarrollos').style.display='none';document.getElementById('table-desarrollos').style.display='table';renderDesarrollos();updateKPIs()});db.ref('fiori').on('value',function(s){var data=s.val();fioriApps=data?Object.keys(data).map(function(k){return Object.assign({id:k},data[k])}):[];fioriApps.sort(function(a,b){return new Date(b.fechaPublicacion||0)-new Date(a.fechaPublicacion||0)});document.getElementById('loading-fiori').style.display='none';document.getElementById('table-fiori').style.display='table';renderFiori();updateKPIs()});db.ref('transportes').on('value',function(s){var data=s.val();transportes=data?Object.keys(data).map(function(k){return Object.assign({id:k},data[k])}):[];transportes.sort(function(a,b){return new Date(b.fechaCreacion||0)-new Date(a.fechaCreacion||0)});document.getElementById('loading-transportes').style.display='none';document.getElementById('table-transportes').style.display='table';renderTransportes();updateKPIs()})}
function renderDesarrollos(data){data=data||desarrollos;var tbody=document.getElementById('tbody-desarrollos');tbody.innerHTML='';if(data.length===0){tbody.innerHTML='<tr><td colspan="11" style="text-align:center;padding:40px;color:#999">No hay desarrollos</td></tr>';return}data.forEach(function(item){var idx=desarrollos.findIndex(function(d){return d.id===item.id});tbody.innerHTML+='<tr><td><strong>'+(item.nombre||'')+'</strong></td><td>'+(item.tipo||'')+'</td><td>'+(item.modulo||'')+'</td><td>'+(item.desarrollador||'')+'</td><td><span class="status-badge status-'+(item.estado||'')+'">'+getText(item.estado,'estado')+'</span></td><td><span class="status-badge complexity-'+(item.complejidad||'')+'">'+getText(item.complejidad,'comp')+'</span></td><td>'+(item.otAsociada||'-')+'</td><td>'+fDate(item.fechaInicio)+'</td><td>'+fDate(item.fechaFin)+'</td><td title="'+(item.descripcion||'')+'">'+trunc(item.descripcion,40)+'</td><td class="actions"><button class="btn-small btn-edit" onclick="editItem(\'desarrollos\','+idx+')">‚úèÔ∏è</button><button class="btn-small btn-delete" onclick="deleteItem(\'desarrollos\','+idx+')">üóëÔ∏è</button></td></tr>'})}
function renderFiori(data){data=data||fioriApps;var tbody=document.getElementById('tbody-fiori');tbody.innerHTML='';if(data.length===0){tbody.innerHTML='<tr><td colspan="11" style="text-align:center;padding:40px;color:#999">No hay apps Fiori</td></tr>';return}data.forEach(function(item){var idx=fioriApps.findIndex(function(f){return f.id===item.id});tbody.innerHTML+='<tr><td><strong>'+(item.nombre||'')+'</strong></td><td>'+(item.idSemantico||'')+'</td><td>'+(item.catalogo||'')+'</td><td>'+(item.grupoTiles||'')+'</td><td title="'+(item.roles||'')+'">'+trunc(item.roles,30)+'</td><td><a href="'+(item.url||'#')+'" target="_blank">üîó</a></td><td><span class="status-badge status-'+(item.estado||'')+'">'+getText(item.estado,'fiori')+'</span></td><td><span class="status-badge status-'+(item.ambiente||'')+'">'+(item.ambiente||'')+'</span></td><td>'+fDateTime(item.fechaPublicacion)+'</td><td>'+(item.responsable||'')+'</td><td class="actions"><button class="btn-small btn-edit" onclick="editItem(\'fiori\','+idx+')">‚úèÔ∏è</button><button class="btn-small btn-delete" onclick="deleteItem(\'fiori\','+idx+')">üóëÔ∏è</button></td></tr>'})}
function renderTransportes(data){data=data||transportes;var tbody=document.getElementById('tbody-transportes');tbody.innerHTML='';if(data.length===0){tbody.innerHTML='<tr><td colspan="12" style="text-align:center;padding:40px;color:#999">No hay transportes</td></tr>';return}data.forEach(function(item){var idx=transportes.findIndex(function(t){return t.id===item.id});tbody.innerHTML+='<tr><td><strong>'+(item.numero||'')+'</strong></td><td>'+(item.tipo||'')+'</td><td title="'+(item.descripcion||'')+'">'+trunc(item.descripcion,40)+'</td><td>'+(item.desarrollador||'')+'</td><td>'+fDate(item.fechaCreacion)+'</td><td class="env-check">'+(item.passedDES?'<span class="env-passed">‚úÖ</span>':'<span class="env-not-passed">‚ùå</span>')+'</td><td class="env-check">'+(item.passedQAS?'<span class="env-passed">‚úÖ</span>':'<span class="env-not-passed">‚ùå</span>')+'</td><td class="env-check">'+(item.passedPRD?'<span class="env-passed">‚úÖ</span>':'<span class="env-not-passed">‚ùå</span>')+'</td><td><span class="status-badge status-'+(item.estado||'')+'">'+getText(item.estado,'ot')+'</span></td><td><span class="status-badge priority-'+(item.prioridad||'')+'">'+getText(item.prioridad,'prior')+'</span></td><td title="'+(item.objetosIncluidos||'')+'">'+trunc(item.objetosIncluidos,30)+'</td><td class="actions"><button class="btn-small btn-edit" onclick="editItem(\'transportes\','+idx+')">‚úèÔ∏è</button><button class="btn-small btn-delete" onclick="deleteItem(\'transportes\','+idx+')">üóëÔ∏è</button></td></tr>'})}
function updateKPIs(){document.getElementById('kpi-desarrollos').textContent=desarrollos.length;document.getElementById('kpi-completados').textContent=desarrollos.filter(function(d){return d.estado==='completado'}).length;document.getElementById('kpi-en-desarrollo').textContent=desarrollos.filter(function(d){return d.estado==='desarrollo'||d.estado==='pruebas'}).length;document.getElementById('kpi-fiori').textContent=fioriApps.length;document.getElementById('kpi-transportes').textContent=transportes.length;document.getElementById('kpi-prod').textContent=transportes.filter(function(t){return t.estado==='PRD'}).length}
function switchTab(tab){document.querySelectorAll('.tab').forEach(function(t){t.classList.remove('active')});document.querySelectorAll('.tab-content').forEach(function(c){c.classList.remove('active')});document.querySelector('.tab[onclick*="'+tab+'"]').classList.add('active');document.getElementById('tab-'+tab).classList.add('active')}
function showModal(type){editingId=null;editingType=type;document.getElementById('form-'+type).reset();document.getElementById('modal-title-'+type).textContent=type==='desarrollos'?'Nuevo Desarrollo':type==='fiori'?'Nueva Publicaci√≥n':'Nuevo Transporte';if(type==='desarrollos')document.getElementById('dev-fecha-inicio').value=new Date().toISOString().split('T')[0];if(type==='transportes')document.getElementById('ot-fecha-creacion').value=new Date().toISOString().split('T')[0];document.getElementById('modal-'+type).style.display='block'}
function closeModal(type){document.getElementById('modal-'+type).style.display='none';editingId=null}
function editItem(type,idx){var item=type==='desarrollos'?desarrollos[idx]:type==='fiori'?fioriApps[idx]:transportes[idx];if(!item)return;editingId=item.id;editingType=type;if(type==='desarrollos'){document.getElementById('modal-title-desarrollos').textContent='Editar Desarrollo';document.getElementById('dev-nombre').value=item.nombre||'';document.getElementById('dev-tipo').value=item.tipo||'';document.getElementById('dev-modulo').value=item.modulo||'';document.getElementById('dev-desarrollador').value=item.desarrollador||'';document.getElementById('dev-estado').value=item.estado||'';document.getElementById('dev-complejidad').value=item.complejidad||'';document.getElementById('dev-ot').value=item.otAsociada||'';document.getElementById('dev-fecha-inicio').value=item.fechaInicio||'';document.getElementById('dev-fecha-fin').value=item.fechaFin||'';document.getElementById('dev-descripcion').value=item.descripcion||'';document.getElementById('dev-observaciones').value=item.observaciones||''}else if(type==='fiori'){document.getElementById('modal-title-fiori').textContent='Editar Publicaci√≥n';document.getElementById('fiori-nombre').value=item.nombre||'';document.getElementById('fiori-id').value=item.idSemantico||'';document.getElementById('fiori-catalogo').value=item.catalogo||'';document.getElementById('fiori-grupo').value=item.grupoTiles||'';document.getElementById('fiori-roles').value=item.roles||'';document.getElementById('fiori-url').value=item.url||'';document.getElementById('fiori-estado').value=item.estado||'';document.getElementById('fiori-ambiente').value=item.ambiente||'';document.getElementById('fiori-fecha').value=item.fechaPublicacion||'';document.getElementById('fiori-responsable').value=item.responsable||'';document.getElementById('fiori-observaciones').value=item.observaciones||''}else{document.getElementById('modal-title-transportes').textContent='Editar Transporte';document.getElementById('ot-numero').value=item.numero||'';document.getElementById('ot-tipo').value=item.tipo||'';document.getElementById('ot-descripcion').value=item.descripcion||'';document.getElementById('ot-desarrollador').value=item.desarrollador||'';document.getElementById('ot-fecha-creacion').value=item.fechaCreacion||'';document.getElementById('ot-estado').value=item.estado||'';document.getElementById('ot-prioridad').value=item.prioridad||'';document.getElementById('ot-passed-des').checked=item.passedDES||false;document.getElementById('ot-passed-qas').checked=item.passedQAS||false;document.getElementById('ot-passed-prd').checked=item.passedPRD||false;document.getElementById('ot-objetos').value=item.objetosIncluidos||'';document.getElementById('ot-fecha-transporte').value=item.fechaTransporte||'';document.getElementById('ot-observaciones').value=item.observaciones||''}document.getElementById('modal-'+type).style.display='block'}
function deleteItem(type,idx){var item=type==='desarrollos'?desarrollos[idx]:type==='fiori'?fioriApps[idx]:transportes[idx];if(!item||!confirm('¬øEliminar "'+(item.nombre||item.numero||'este registro')+'"?'))return;db.ref(type+'/'+item.id).remove().then(function(){notify('Eliminado','success')}).catch(function(e){notify('Error: '+e.message,'error')})}
document.getElementById('form-desarrollos').addEventListener('submit',function(e){e.preventDefault();var data={nombre:document.getElementById('dev-nombre').value.trim(),tipo:document.getElementById('dev-tipo').value,modulo:document.getElementById('dev-modulo').value,desarrollador:document.getElementById('dev-desarrollador').value.trim(),estado:document.getElementById('dev-estado').value,complejidad:document.getElementById('dev-complejidad').value,otAsociada:document.getElementById('dev-ot').value.trim(),fechaInicio:document.getElementById('dev-fecha-inicio').value,fechaFin:document.getElementById('dev-fecha-fin').value,descripcion:document.getElementById('dev-descripcion').value.trim(),observaciones:document.getElementById('dev-observaciones').value.trim(),lastModified:new Date().toISOString()};if(!editingId)data.created=new Date().toISOString();var ref=editingId?db.ref('desarrollos/'+editingId):db.ref('desarrollos').push();ref.set(data).then(function(){notify(editingId?'Actualizado':'Creado','success');closeModal('desarrollos')}).catch(function(e){notify('Error: '+e.message,'error')})});
document.getElementById('form-fiori').addEventListener('submit',function(e){e.preventDefault();var data={nombre:document.getElementById('fiori-nombre').value.trim(),idSemantico:document.getElementById('fiori-id').value.trim(),catalogo:document.getElementById('fiori-catalogo').value.trim(),grupoTiles:document.getElementById('fiori-grupo').value.trim(),roles:document.getElementById('fiori-roles').value.trim(),url:document.getElementById('fiori-url').value.trim(),estado:document.getElementById('fiori-estado').value,ambiente:document.getElementById('fiori-ambiente').value,fechaPublicacion:document.getElementById('fiori-fecha').value,responsable:document.getElementById('fiori-responsable').value.trim(),observaciones:document.getElementById('fiori-observaciones').value.trim(),lastModified:new Date().toISOString()};if(!editingId)data.created=new Date().toISOString();var ref=editingId?db.ref('fiori/'+editingId):db.ref('fiori').push();ref.set(data).then(function(){notify(editingId?'Actualizado':'Creado','success');closeModal('fiori')}).catch(function(e){notify('Error: '+e.message,'error')})});
document.getElementById('form-transportes').addEventListener('submit',function(e){e.preventDefault();var data={numero:document.getElementById('ot-numero').value.trim(),tipo:document.getElementById('ot-tipo').value,descripcion:document.getElementById('ot-descripcion').value.trim(),desarrollador:document.getElementById('ot-desarrollador').value.trim(),fechaCreacion:document.getElementById('ot-fecha-creacion').value,estado:document.getElementById('ot-estado').value,prioridad:document.getElementById('ot-prioridad').value,passedDES:document.getElementById('ot-passed-des').checked,passedQAS:document.getElementById('ot-passed-qas').checked,passedPRD:document.getElementById('ot-passed-prd').checked,objetosIncluidos:document.getElementById('ot-objetos').value.trim(),fechaTransporte:document.getElementById('ot-fecha-transporte').value,observaciones:document.getElementById('ot-observaciones').value.trim(),lastModified:new Date().toISOString()};if(!editingId)data.created=new Date().toISOString();var ref=editingId?db.ref('transportes/'+editingId):db.ref('transportes').push();ref.set(data).then(function(){notify(editingId?'Actualizado':'Creado','success');closeModal('transportes')}).catch(function(e){notify('Error: '+e.message,'error')})});
function applyFilters(type){var search=document.getElementById('search-'+type).value.toLowerCase();var filtered=[];if(type==='desarrollos'){var mod=document.getElementById('filter-modulo').value;var est=document.getElementById('filter-estado-dev').value;filtered=desarrollos.filter(function(i){var s=!search||(i.nombre||'').toLowerCase().includes(search)||(i.descripcion||'').toLowerCase().includes(search)||(i.desarrollador||'').toLowerCase().includes(search);var m=!mod||i.modulo===mod;var e=!est||i.estado===est;return s&&m&&e});renderDesarrollos(filtered)}else if(type==='fiori'){var amb=document.getElementById('filter-ambiente-fiori').value;var estf=document.getElementById('filter-estado-fiori').value;filtered=fioriApps.filter(function(i){var s=!search||(i.nombre||'').toLowerCase().includes(search)||(i.idSemantico||'').toLowerCase().includes(search)||(i.catalogo||'').toLowerCase().includes(search);var a=!amb||i.ambiente===amb;var e=!estf||i.estado===estf;return s&&a&&e});renderFiori(filtered)}else{var esto=document.getElementById('filter-estado-ot').value;var pri=document.getElementById('filter-prioridad').value;filtered=transportes.filter(function(i){var s=!search||(i.numero||'').toLowerCase().includes(search)||(i.descripcion||'').toLowerCase().includes(search)||(i.desarrollador||'').toLowerCase().includes(search);var e=!esto||i.estado===esto;var p=!pri||i.prioridad===pri;return s&&e&&p});renderTransportes(filtered)}}
function exportToCSV(type){var data=type==='desarrollos'?desarrollos:type==='fiori'?fioriApps:transportes;if(data.length===0){notify('No hay datos','error');return}var headers,rows;if(type==='desarrollos'){headers=['Nombre','Tipo','M√≥dulo','Desarrollador','Estado','Complejidad','OT','FechaInicio','FechaFin','Descripci√≥n','Observaciones'];rows=data.map(function(i){return[i.nombre,i.tipo,i.modulo,i.desarrollador,getText(i.estado,'estado'),getText(i.complejidad,'comp'),i.otAsociada,i.fechaInicio,i.fechaFin,i.descripcion,i.observaciones]})}else if(type==='fiori'){headers=['Nombre','IDSemantico','Cat√°logo','GrupoTiles','Roles','URL','Estado','Ambiente','FechaPublicaci√≥n','Responsable','Observaciones'];rows=data.map(function(i){return[i.nombre,i.idSemantico,i.catalogo,i.grupoTiles,i.roles,i.url,getText(i.estado,'fiori'),i.ambiente,i.fechaPublicacion,i.responsable,i.observaciones]})}else{headers=['N√∫mero','Tipo','Descripci√≥n','Desarrollador','FechaCreaci√≥n','DES','QAS','PRD','Estado','Prioridad','Objetos','FechaTransporte','Observaciones'];rows=data.map(function(i){return[i.numero,i.tipo,i.descripcion,i.desarrollador,i.fechaCreacion,i.passedDES?'S√≠':'No',i.passedQAS?'S√≠':'No',i.passedPRD?'S√≠':'No',getText(i.estado,'ot'),getText(i.prioridad,'prior'),i.objetosIncluidos,i.fechaTransporte,i.observaciones]})}var csv=[headers.join(',')];rows.forEach(function(r){csv.push(r.map(function(c){return'"'+(c||'').toString().replace(/"/g,'""')+'"'}).join(','))});var blob=new Blob(['\uFEFF'+csv.join('\n')],{type:'text/csv;charset=utf-8;'});var link=document.createElement('a');link.href=URL.createObjectURL(blob);link.download=type+'_'+new Date().toISOString().split('T')[0]+'.csv';link.click();notify('CSV exportado','success')}
function trunc(t,max){if(!t)return'';return t.length>max?t.substring(0,max)+'...':t}
function fDate(d){if(!d)return'-';try{return new Date(d).toLocaleDateString('es-ES')}catch(e){return d}}
function fDateTime(d){if(!d)return'-';try{return new Date(d).toLocaleString('es-ES')}catch(e){return d}}
function getText(val,type){var maps={estado:{pendiente:'Pendiente',desarrollo:'En Desarrollo',pruebas:'En Pruebas',completado:'Completado'},comp:{baja:'Baja',media:'Media',alta:'Alta'},fiori:{pendiente:'Pendiente',publicado:'Publicado',error:'Error'},ot:{pendiente:'Pendiente',DES:'DES',QAS:'QAS',PRD:'PRD',error:'Error'},prior:{alta:'ALTA',media:'MEDIA',baja:'BAJA'}};return(maps[type]&&maps[type][val])||val||'-'}
function notify(msg,type){var n=document.getElementById('notification');n.textContent=msg;n.className='notification '+(type||'success');n.classList.add('show');setTimeout(function(){n.classList.remove('show')},4000)}
window.onclick=function(e){if(e.target.className==='modal'){e.target.style.display='none';editingId=null}};
if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',initFirebase)}else{initFirebase()}